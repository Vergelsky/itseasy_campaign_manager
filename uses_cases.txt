# ПОЛЬЗОВАТЕЛЬСКИЕ СЦЕНАРИИ
# Campaign Manager для Keitaro

================================================================================
## 1. АВТОРИЗАЦИЯ
================================================================================

### Предусловия:
  - Сервис доступен
  - Keitaro доступен
  - У пользователя есть API ключ

### Процесс:
  1. Пользователь заходит на страницу сервиса
  2. Перед пользователем отображается:
     - Поле для ввода API ключа
     - Ссылка на страницу Keitaro, где можно получить ключ
  3. Пользователь вводит API ключ
  4. Пользователь попадает на:
     - Главную страницу приложения (если это первый вход)
     - ИЛИ на ту страницу, где был последний раз (информация хранится в профиле)

### Результат:
  ✓ Пользователь авторизован
  ✓ Создана запись пользователя в БД с API ключом
  ✓ В cookies сохранён ID пользователя

### Обработка ошибок:
  ✗ Недоступен Keitaro → показываем сообщение об этом
  ✗ Keitaro отверг ключ → показываем сообщение о неверном ключе


================================================================================
## 2. ПРОСМОТР ДАННЫХ
================================================================================

### Предусловия:
  - Пользователь авторизован
  - Keitaro доступен

### Процесс:

#### 2.1. Главная страница (список кампаний)
  Пользователь видит таблицу со списком рекламных кампаний

  **Столбцы таблицы:**
  - ID
  - Название (кликабельная ссылка на страницу кампании)
  - Источник
  - Потоки
  - Клики
  - Конверсия
  - CR (продажи)
  - Доход (подтверждённый)
  - Расход
  - Прибыль (подтверждённая)
  - ROI (подтверждённая)

#### 2.2. Страница кампании (детали по потокам)
  Пользователь видит таблицу со списком потоков выбранной рекламной кампании

  **Столбцы таблицы:**
  - Оффер (название)
  - Share (процент распределения)
  - Stats (функционал добавится позже)
  - Trends (функционал добавится позже)
  - Actions

  **Структура таблицы:**
  - Таблица горизонтально разделена заголовками по отдельным потокам
  - Потоки без офферов имеют только заголовок (без данных)
  - В заголовке каждого потока есть поле для добавления оффера

  **Управляющие элементы (над таблицей):**
  - Кнопка "Fetch streams from Keitaro"
  - Кнопка "View in Keitaro"

  **Синхронизация данных:**
  - При первом заходе таблица пуста → нужно нажать "Fetch streams from Keitaro"
  - При переходе на страницу:
    * Отображаются сохранённые в БД данные
    * Асинхронно выполняется запрос в Keitaro
    * Если данные не совпадают → показывается предупреждение о необходимости синхронизации
  
  **Визуальные индикаторы состояния:**
  - Несохранённые изменения пользователя очевидны из:
    * Бежевого цвета таблицы потока
    * Цветовых маркеров названий офферов (зелёный/красный bold)
    * Цветовых маркеров значений Share (зелёный/красный bold)
  - Предупреждение о расхождении с Keitaro показывается только если:
    * На стороне Keitaro были изменения, не отражённые в БД


================================================================================
## 3. ОБМЕН ДАННЫМИ С KEITARO
================================================================================

### Предусловия:
  - Пользователь авторизован
  - Keitaro доступен
  - Пользователь на странице рекламной кампании

### Процесс:

#### 3.1. Загрузка данных из Keitaro
  - Нажатие кнопки "Fetch streams from Keitaro"
  - Загружаются актуальные данные из Keitaro
  - Таблица обновляется

#### 3.2. Отправка изменений в Keitaro
  При редактировании данных в потоке:
  
  **Визуальные изменения:**
  - Вся часть таблицы с этим потоком подсвечивается бежевым цветом
  
  **Появляются кнопки:**
  В заголовке потока:
    - "Push to Keitaro" (выгрузка изменений в Keitaro)
    - "Cancel" (отмена изменений)
  
  Над таблицей:
    - "Push to Keitaro" (для всей таблицы)
    - "Cancel" (для всей таблицы)


================================================================================
## 4. УПРАВЛЕНИЕ ОФФЕРАМИ В ПОТОКАХ
================================================================================

### 4.1. Добавление оффера

**Процесс:**
  1. В заголовке потока начинаем вводить данные оффера
  2. Автодополнение предлагает подсказки:
     - Отображаются офферы, содержащие введённую подстроку
     - Результаты берутся из закешированных в БД данных Keitaro (моментально)
     - При получении фокуса полем поиска асинхронно обновляется кэш
     - После обновления кэша список результатов автоматически обновляется
  3. Вводим до конца или выбираем из подсказки
  4. Нажимаем "Добавить"

**Визуальные изменения:**
  - Оффер добавляется в таблицу этого потока
  - Таблица потока меняет цвет на бежевый
  - Название добавленного оффера становится зелёным bold
  - Значения Share пересчитываются согласно правилам
  - Изменённые значения Share становятся зелёными bold
  - Появляются кнопки "Push to Keitaro" / "Cancel"

**Сохранение:**
  - Нажимаем "Push to Keitaro"
  - Данные отправляются в Keitaro
  - Таблица принимает прежний вид с добавленной строкой


### 4.2. Удаление оффера

**Процесс:**
  1. В колонке "Actions" нажимаем кнопку "Remove" у нужного оффера

**Визуальные изменения:**
  - Таблица этого потока становится бежевой
  - Название удаляемого оффера становится красным bold
  - Share удаляемого оффера становится 0% и красным bold
  - Остальные Share пересчитываются согласно правилам
  - Изменённые значения становятся зелёными bold
  - Появляются кнопки "Push to Keitaro" / "Cancel"

**Сохранение:**
  - Нажимаем "Push to Keitaro"
  - Данные отправляются в Keitaro
  - Таблица принимает прежний вид без удалённой строки


### 4.3. Закрепление Share (фиксация процента распределения)

**Управление:**
  - В колонке Share возле значений есть значок булавки "зафиксировать"
  - При клике на значение открывается форма для ручного ввода
  - При задании значения вручную или клике на булавку → булавка фиксируется

**Процесс фиксации:**
  - При вводе значения вручную → остальные значения пересчитываются
  - Зафиксированные значения не пересчитываются при последующих изменениях


================================================================================
## 5. ПРАВИЛА ПЕРЕСЧЁТА SHARE
================================================================================

### Основные правила:
  1. Значения должны быть целыми числами
  2. Сумма всех значений должна составлять 100%
  3. Зафиксированные значения НЕ пересчитываются

### Алгоритм распределения:
  - Share распределяются **равными частями** между незафиксированными офферами
  - При добавлении оффера: свободные проценты делятся поровну
  - При удалении оффера: освободившиеся проценты перераспределяются поровну между остальными незафиксированными

### Валидация:
  Если при вводе нового значения возникает одна из ситуаций:
  - Сумма зафиксированных значений становится больше 100%
  - Остальные значения становятся меньше 1% и не могут быть равномерно распределены
  
  **Действия:**
  - Вводимое значение становится красным
  - Сохранение блокируется до:
    * Исправления на допустимое значение
    * ИЛИ закрытия формы без сохранения


================================================================================
## 6. ДОПОЛНИТЕЛЬНЫЕ ТЕХНИЧЕСКИЕ ДЕТАЛИ
================================================================================

### 6.1. Кэширование офферов
  - Офферы из Keitaro кэшируются в БД
  - Кэш обновляется асинхронно при получении фокуса полем поиска
  - Поиск по кэшу выполняется моментально (поиск по подстроке)

### 6.2. Синхронизация и конфликты
  - При одновременном редактировании сохраняется наиболее свежий вариант
  - Система отслеживает изменения на стороне Keitaro
  - Предупреждение показывается только при внешних изменениях

### 6.3. Права доступа
  - Все пользователи имеют одинаковые права
  - Разделение по ролям не предусмотрено
